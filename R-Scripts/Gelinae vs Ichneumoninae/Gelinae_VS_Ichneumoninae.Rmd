---
title: "Gelinae_vs_Ichneumoninae_Analysis"
author: "Robin von Allmen"
date: "18 3 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir ="~/GitHub/Ichneumonidae/R-Scripts/Gelinae vs Ichneumoninae", echo = TRUE)
library(knitr)
require(rgl)
options(rgl.useNULL = TRUE) # Suppress the separate window.
knitr::knit_hooks$set(webgl = hook_webgl)
library(geomorph)


#FUNCTION TO ASSERT COLOR TO A CERTAIN GROUP
give_color <- function(subfamily) {
 if(!is.vector(subfamily)){
  color <- switch(substr(subfamily,8,13), "gelina" = "goldenrod1", "fossil"="black", "ichneu" = "blueviolet")}
  
  else{
    color = matrix( NA, length(subfamily))
    for(i in 1:length(subfamily)){
      color[i] <-switch(if(nchar(subfamily[i])>15){substr(subfamily[i],8,13)}else{substr(subfamily[i],1,6)}, "gelina" = "goldenrod1", "fossil"="black", "ichneu" = "blueviolet")

    }
  }
 return(color)
}
```

## Preparing Data


```{r cars, results=FALSE}

landmark = readland.tps("DATA_GELINAE.tps",specID = "ID", readcurves = T, warnmsg = TRUE)
landmark2 = readland.tps("DATA_ICHNEUMONINAE.tps",specID = "ID", readcurves = T, warnmsg = TRUE)

landmark <- Abind(landmark, landmark2)
##      define classifiers (subfam or tribes)
species = as.factor( substr( dimnames(landmark)[[3]], 1, 6))
subfam = as.factor( substr( dimnames(landmark)[[3]], 8, 13))
areolet = as.factor( substr( dimnames(landmark)[[3]], 15, 15))
tribe = as.factor( substr( dimnames(landmark)[[3]], 17, 19))
sex = as.factor( substr( dimnames(landmark)[[3]], 24, 24))
sex[sex == "." | sex=="J"] <- "u"


##      define Semilandmarks, first LM is the start, last one the end (those are both
##      fixed landmarks, in between are the semilandmarks):
sliders = define.sliders(c(15,22:29,16))

##      procrustes fit - "superimposition" - rotates and scales the landmarks to their closest distance,
##      minimizing the shape and size difference:
proD<-gpagen(landmark, surfaces = NULL, curves = sliders,
             PrinAxes = FALSE, max.iter = NULL, ProcD = F, Proj = TRUE,
             print.progress = TRUE)

```

## PCA Analysis

When comparing the Procrustes fit on the model that compares Ichneumoninae and Gelinae with eachother, we are surprised by the fact, that the curve between LM 15-16 does not improve dinstiguishment of the two subfamilies. Hence we proceed in this case with the analyses only obtained from fixed Landmarks.

```{r plot1}

PCA <-plotTangentSpace(proD$coords, groups=subfam, legend=T)
legend("topright", legend= levels(tribe), col=give_color(levels(subfam)), pch=rep(19,14) )
title(main = "Gelinae vs Ichneumoninae")


```

```{r plot,echo=FALSE}
  ## the more beautiful version:

mat <- matrix(c(4,5,0,1,1,2,1,1,3), 3)
layout(mat, widths=c(1,1,1), heights=c(1,1,1))# set the size of the rows and columns

par(mar=c(4, 4, 1, 1)) # sets the margins
plot(PCA$pc.scores[,1],PCA$pc.scores[,2], col= give_color(as.vector(subfam)), asp=T, las=1,pch=16, cex=1.5)
legend("topright", legend= levels(subfam), col= give_color(levels(subfam)), pch=rep(19,14) )

segments(min(PCA$pc.scores[,1]), 0,  max(PCA$pc.scores[,1]),0, col="grey", lty="dashed")
segments(0, min(PCA$pc.scores[,2]), 0,  max(PCA$pc.scores[,2]), col="grey", lty="dashed")
text(PCA$pc.scores[,1],PCA$pc.scores[,2], species)

ref <- mshape(proD$coords)
#qw= c(1,4,2,6,5,7,3)
par(mar = c(0,0,0,0)) # sets the margins

plotRefToTarget(ref,PCA$pc.shapes$PC1min)
# Item 3
plotRefToTarget(ref,PCA$pc.shapes$PC1max)
# Item 4
plotRefToTarget(ref,PCA$pc.shapes$PC2max)
# Item 5
plotRefToTarget(ref,PCA$pc.shapes$PC2min)
```


## 3D-Plot

with the PCA scores u are also able to generate 3d plots which compare several Principal Components at once:

```{r Procrustes Distances, message = FALSE, results='hide', include=FALSE}
library(Evomorph)

inlist = list(proD$coords [,,])
for ( j in 1: dim(proD$coords )[3] )
  inlist[[j]] = proD$coords [,,j]


ID = paste(paste (subfam,species, sep = "_", collapse = NULL, recycle0 = FALSE), sex, sep = "_", collapse = NULL, recycle0 = F)

### PC1 for PC1dist thingy.. for empty matrix: ###################
PCA_sc<-PCA$pc.scores

row.names(PCA_sc) = ID
PCdist = as.matrix( dist(PCA_sc))

###  make empty matrix 
Proc_dist= matrix( NA, dim(PCA_sc)[1], dim(PCA_sc)[1] )

colnames(Proc_dist) = ID
rownames(Proc_dist) = ID

###  make a loop : calculate proc distances for each row. 

for ( i in 1:length(ID)){
  Proc_dist[i,] = ShapeDist(inlist, inlist[[i]])
}

write.table(Proc_dist,"Proc_distances_ban_pim_oph_cte.txt", sep=" ",row.names = TRUE, col.names = TRUE)

###################################################################
Proc_dist = read.table("Proc_distances_ban_pim_oph_cte.txt", header=T)

```


```{r Dendrogramm, results='hide', message = FALSE, fig.width= 22, fig.height= 12}


require("dendextend") ## needs a dendrogram


# Create a vector of colors, darkgreen if am is 0, green if 1.

par(mar=c(10,2,1,0), cex = 1, font= 2)

library(pvclust)

result <- pvclust(scale(Proc_dist), method.dist="cor", method.hclust="average", nboot=1000)

dend <- as.dendrogram(result)
Label <- dend%>%labels
my_colors1 = give_color(Label)


result %>% as.dendrogram %>%
  set("labels_color", value = my_colors1)%>%
  set("branches_k_color", value = c("skyblue", "darkorange", "grey","darkorange4","deepskyblue4",
                                    "darkolivegreen3","darkorchid1"),k =7) %>%
  # set("labels", Label2[result$hclust$order]) %>%
  set("labels_cex", 0.8)  %>%
  set("leaves_pch", 19)  %>%
  set("nodes_cex", 0.4) %>%

   plot(main = "Cluster dendrogram with AU/BP values (%)\n reproduced plot with dendrogram", axes = FALSE)

result %>% text(print.num = FALSE, print.pv = "au")
result %>% pvrect(alpha=0.95)


legend("topleft", legend=levels(subfam), col= give_color(levels(subfam)), pch=15, cex = 2)
colored_bars(dend=as.dendrogram(result), col = my_colors1, rowLabels = "subfam", sort_by_labels_order = FALSE)


```